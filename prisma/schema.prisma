// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  SUPER_ADMIN
  GERENTE
  ANFITRION
  TECNICO
  QA
  ALMACEN
}

enum OrderStatus {
  TRIAJE
  DIAGNOSTICO
  ESPERA_REPUESTO
  MICRO_SOLDADURA
  QA
  LISTO
  ENTREGADO
  GARANTIA
}

enum Priority {
  BAJA
  MEDIA
  ALTA
  URGENTE
}

enum DeviceType {
  IPHONE
  IPAD
  ANDROID
  WATCH
  LAPTOP
  OTHER
}

enum DeviceBrand {
  APPLE
  SAMSUNG
  XIAOMI
  MOTOROLA
  HUAWEI
  OTHER
}

enum PaymentMethod {
  ZELLE
  CASH_USD
  CASH_VES
  PAGO_MOVIL
  BINANCE
  TRANSFER
}

enum InvoiceStatus {
  PENDING
  PAID
  PARTIAL
  CANCELLED
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

enum RegisterStatus {
  OPEN
  CLOSED
  DISCREPANCY
}

// ==================== MODELS ====================

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  role      UserRole @default(ANFITRION)
  isActive  Boolean  @default(true)
  avatar    String?
  
  // Relations
  storeId   String?
  store     Store?   @relation(fields: [storeId], references: [id])
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?
  
  // Relations
  ordersCreated   ServiceOrder[] @relation("CreatedBy")
  ordersAssigned  ServiceOrder[] @relation("AssignedTo")
  timeEntries     TimeEntry[]
  cashRegisters   CashRegister[]
  auditLogs       AuditLog[]
  
  @@map("users")
}

model Store {
  id              String         @id @default(uuid())
  name            String
  code            String         @unique
  address         String
  phone           String
  email           String
  logo            String?
  isActive        Boolean        @default(true)
  
  // Fiscal Data
  rif             String?
  razonSocial     String?
  direccionFiscal String?
  
  // Relations
  users           User[]
  orders          ServiceOrder[]
  parts           PartStock[]
  cashRegisters   CashRegister[]
  safeKits        SafeKit[]
  courtesyDevices CourtesyDevice[]
  invoices        Invoice[]

  // Inverse relations for transfers
  transfersFrom   StockTransfer[] @relation("FromTransfer")
  transfersTo     StockTransfer[] @relation("ToTransfer")
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@map("stores")
}

model BCVRate {
  id          String   @id @default(uuid())
  rate        Decimal  @db.Decimal(10, 2)
  date        DateTime @default(now())
  source      String   // 'automatic' | 'manual'
  updatedBy   String?
  
  createdAt   DateTime @default(now())
  
  @@map("bcv_rates")
}

model Customer {
  id          String   @id @default(uuid())
  name        String
  email       String?
  phone       String
  documentId  String   @unique
  address     String?
  
  // Relations
  devices     Device[]
  orders      ServiceOrder[]
  invoices    Invoice[]
  loans       DeviceLoan[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("customers")
}

model Device {
  id            String         @id @default(uuid())
  type          DeviceType
  brand         DeviceBrand
  model         String
  serialNumber  String
  imei          String?
  color         String?
  storage       String?
  notes         String?
  
  // Relations
  customerId    String
  customer      Customer       @relation(fields: [customerId], references: [id])
  orders        ServiceOrder[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@map("devices")
}

model ServiceOrder {
  id                String       @id @default(uuid())
  orderNumber       String       @unique
  status            OrderStatus  @default(TRIAJE)
  priority          Priority     @default(MEDIA)
  
  // Reception
  reportedIssue     String
  termsAccepted     Boolean      @default(false)
  customerSignature String?
  
  // Technical
  diagnosis         String?
  solution          String?
  
  // Financial
  estimatedCost     Decimal      @default(0) @db.Decimal(10, 2)
  finalCost         Decimal      @default(0) @db.Decimal(10, 2)
  paidAmount        Decimal      @default(0) @db.Decimal(10, 2)
  
  // Relations
  customerId      String
  customer        Customer     @relation(fields: [customerId], references: [id])
  deviceId        String
  device          Device       @relation(fields: [deviceId], references: [id])
  storeId         String
  store           Store        @relation(fields: [storeId], references: [id])
  
  createdById      String
  createdBy        User         @relation("CreatedBy", fields: [createdById], references: [id])
  assignedToId     String?
  assignedTo       User?        @relation("AssignedTo", fields: [assignedToId], references: [id])
  
  // Related data
  checklist       ChecklistItem[]
  photos          Photo[]
  partsUsed       PartUsage[]
  internalPhotos  Photo[]       @relation("InternalPhotos")
  timeEntries     TimeEntry[]
  qaResult        QAResult?
  invoice         Invoice?
  
  // Logistics
  safeKit         SafeKit?
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  completedAt     DateTime?
  
  @@map("service_orders")
}

model ChecklistItem {
  id          String       @id @default(uuid())
  category    String
  item        String
  checked     Boolean      @default(false)
  notes       String?
  
  orderId     String
  order       ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("checklist_items")
}

model Photo {
  id          String       @id @default(uuid())
  url         String
  type        String       // 'exterior' | 'interior' | 'document' | 'other'
  description String?
  
  orderId     String
  order       ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // For internal photos relation
  internalOrderId String?
  internalOrder   ServiceOrder? @relation("InternalPhotos", fields: [internalOrderId], references: [id])
  
  uploadedAt  DateTime     @default(now())
  
  @@map("photos")
}

model Part {
  id                String       @id @default(uuid())
  sku               String       @unique
  name              String
  description       String?
  category          String
  compatibleModels  String[]
  
  // Pricing
  costPrice         Decimal      @db.Decimal(10, 2)
  salePrice         Decimal      @db.Decimal(10, 2)
  shippingCost      Decimal      @default(0) @db.Decimal(10, 2)
  operationalCost   Decimal      @default(0) @db.Decimal(10, 2)
  warrantyFund      Decimal      @default(0) @db.Decimal(10, 2)
  
  // Stock management
  minStock          Int          @default(3)
  supplier          String?
  
  // Relations
  stock             PartStock[]
  transfers         StockTransfer[]
  usages            PartUsage[]
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  @@map("parts")
}

model PartStock {
  id        String   @id @default(uuid())
  quantity  Int      @default(0)
  reserved  Int      @default(0)
  
  partId    String
  part      Part     @relation(fields: [partId], references: [id])
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])
  
  @@unique([partId, storeId])
  @@map("part_stocks")
}

model StockTransfer {
  id            String         @id @default(uuid())
  quantity      Int
  status        TransferStatus @default(PENDING)
  
  partId        String
  part          Part           @relation(fields: [partId], references: [id])
  fromStoreId   String
  fromStore     Store          @relation("FromTransfer", fields: [fromStoreId], references: [id])
  toStoreId     String
  toStore       Store          @relation("ToTransfer", fields: [toStoreId], references: [id])
  
  requestedBy   String
  approvedBy    String?
  
  sentAt        DateTime?
  receivedAt    DateTime?
  createdAt     DateTime       @default(now())
  
  @@map("stock_transfers")
}

model PartUsage {
  id          String       @id @default(uuid())
  quantity    Int
  costPrice   Decimal      @db.Decimal(10, 2)
  salePrice   Decimal      @db.Decimal(10, 2)
  
  partId      String
  part        Part         @relation(fields: [partId], references: [id])
  orderId     String
  order       ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("part_usages")
}

model TimeEntry {
  id          String       @id @default(uuid())
  startTime   DateTime
  endTime     DateTime?
  duration    Int?         // in minutes
  description String
  
  technicianId String
  technician   User         @relation(fields: [technicianId], references: [id])
  orderId      String
  order        ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("time_entries")
}

model QAResult {
  id          String       @id @default(uuid())
  passed      Boolean
  testDate    DateTime     @default(now())
  notes       String?
  
  orderId     String       @unique
  order       ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  testedBy    String
  
  tests       QATest[]
  
  @@map("qa_results")
}

model QATest {
  id          String       @id @default(uuid())
  name        String
  passed      Boolean      @default(false)
  notes       String?
  
  qaResultId  String
  qaResult    QAResult     @relation(fields: [qaResultId], references: [id], onDelete: Cascade)
  
  @@map("qa_tests")
}

model SafeKit {
  id              String          @id @default(uuid())
  code            String          @unique
  name            String
  qrCode          String
  status          String          @default("available") // 'available' | 'in-use' | 'maintenance'
  
  storeId         String
  store           Store           @relation(fields: [storeId], references: [id])
  
  currentOrderId  String?         @unique
  currentOrder    ServiceOrder?   @relation(fields: [currentOrderId], references: [id])
  
  createdAt       DateTime        @default(now())
  
  @@map("safe_kits")
}

model CourtesyDevice {
  id            String       @id @default(uuid())
  type          DeviceType
  brand         DeviceBrand
  model         String
  serialNumber  String       @unique
  status        String       @default("available") // 'available' | 'loaned' | 'maintenance'
  
  storeId       String
  store         Store        @relation(fields: [storeId], references: [id])
  
  loans         DeviceLoan[]
  
  createdAt     DateTime     @default(now())
  
  @@map("courtesy_devices")
}

model DeviceLoan {
  id                String         @id @default(uuid())
  loanDate          DateTime       @default(now())
  expectedReturnDate DateTime
  actualReturnDate  DateTime?
  condition         String
  notes             String?
  
  deviceId          String
  device            CourtesyDevice @relation(fields: [deviceId], references: [id])
  customerId        String
  customer          Customer       @relation(fields: [customerId], references: [id])
  orderId           String
  
  @@map("device_loans")
}

model Invoice {
  id              String         @id @default(uuid())
  invoiceNumber   String         @unique
  
  // Totals
  subtotal        Decimal        @db.Decimal(10, 2)
  igtfAmount      Decimal        @default(0) @db.Decimal(10, 2)
  discount        Decimal        @default(0) @db.Decimal(10, 2)
  total           Decimal        @db.Decimal(10, 2)
  totalVES        Decimal        @db.Decimal(10, 2)
  
  // Payment tracking
  paidTotal       Decimal        @default(0) @db.Decimal(10, 2)
  status          InvoiceStatus  @default(PENDING)
  
  // Relations
  customerId      String
  customer        Customer       @relation(fields: [customerId], references: [id])
  storeId         String
  store           Store          @relation(fields: [storeId], references: [id])
  orderId         String?        @unique
  order           ServiceOrder?  @relation(fields: [orderId], references: [id])
  
  items           InvoiceItem[]
  payments        Payment[]
  
  createdBy       String
  createdAt       DateTime       @default(now())
  paidAt          DateTime?
  
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(uuid())
  type        String   // 'service' | 'part' | 'accessory'
  description String
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@map("invoice_items")
}

model Payment {
  id          String        @id @default(uuid())
  method      PaymentMethod
  amount      Decimal       @db.Decimal(10, 2)
  amountVES   Decimal?      @db.Decimal(10, 2)
  reference   String?
  bankName    String?
  phoneNumber String?
  email       String?
  timestamp   DateTime      @default(now())
  
  invoiceId   String
  invoice     Invoice        @relation(fields: [invoiceId