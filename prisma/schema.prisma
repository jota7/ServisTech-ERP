generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Corregido: Se a√±ade un valor por defecto para evitar el error P1012 durante el build
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  SUPER_ADMIN
  GERENTE
  ANFITRION
  TECNICO
  QA
  ALMACEN
}

enum OrderStatus {
  TRIAJE
  DIAGNOSTICO
  ESPERA_REPUESTO
  MICRO_SOLDADURA
  QA
  LISTO
  ENTREGADO
  GARANTIA
}

enum Priority {
  BAJA
  MEDIA
  ALTA
  URGENTE
}

enum DeviceType {
  IPHONE
  IPAD
  ANDROID
  WATCH
  LAPTOP
  OTHER
}

enum DeviceBrand {
  APPLE
  SAMSUNG
  XIAOMI
  MOTOROLA
  HUAWEI
  OTHER
}

enum PaymentMethod {
  ZELLE
  CASH_USD
  CASH_VES
  PAGO_MOVIL
  BINANCE
  TRANSFER
}

enum InvoiceStatus {
  PENDING
  PAID
  PARTIAL
  CANCELLED
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

enum RegisterStatus {
  OPEN
  CLOSED
  DISCREPANCY
}

// ==================== MODELS ====================

model User {
  id              String         @id @default(uuid())
  name            String
  email           String         @unique
  password        String
  role            UserRole       @default(ANFITRION)
  isActive        Boolean        @default(true)
  avatar          String?
  storeId         String?
  store           Store?         @relation(fields: [storeId], references: [id])
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  lastLogin       DateTime?
  ordersCreated   ServiceOrder[] @relation("CreatedBy")
  ordersAssigned  ServiceOrder[] @relation("AssignedTo")
  timeEntries     TimeEntry[]
  cashRegisters   CashRegister[]
  auditLogs       AuditLog[]
  @@map("users")
}

model Store {
  id               String           @id @default(uuid())
  name             String
  code             String           @unique
  address          String
  phone            String
  email            String
  logo             String?
  isActive         Boolean          @default(true)
  rif              String?
  razonSocial      String?
  direccionFiscal  String?
  users            User[]
  orders           ServiceOrder[]
  parts            PartStock[]
  cashRegisters    CashRegister[]
  safeKits         SafeKit[]
  courtesyDevices  CourtesyDevice[]
  invoices         Invoice[]
  transfersFrom    StockTransfer[]  @relation("FromTransfer")
  transfersTo      StockTransfer[]  @relation("ToTransfer")
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  @@map("stores")
}

model BCVRate {
  id          String   @id @default(uuid())
  rate        Decimal  @db.Decimal(10, 2)
  date        DateTime @default(now())
  source      String
  updatedBy   String?
  createdAt   DateTime @default(now())
  @@map("bcv_rates")
}

model Customer {
  id          String         @id @default(uuid())
  name        String
  email       String?
  phone       String
  documentId  String         @unique
  address     String?
  devices     Device[]
  orders      ServiceOrder[]
  invoices    Invoice[]
  loans       DeviceLoan[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  @@map("customers")
}

model Device {
  id            String         @id @default(uuid())
  type          DeviceType
  brand         DeviceBrand
  model         String
  serialNumber  String
  imei          String?
  color         String?
  storage       String?
  notes         String?
  customerId    String
  customer      Customer       @relation(fields: [customerId], references: [id])
  orders        ServiceOrder[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  @@map("devices")
}

model ServiceOrder {
  id                String          @id @default(uuid())
  orderNumber       String          @unique
  status            OrderStatus     @default(TRIAJE)
  priority          Priority        @default(MEDIA)
  reportedIssue     String
  termsAccepted     Boolean         @default(false)
  customerSignature String?
  diagnosis         String?
  solution          String?
  estimatedCost     Decimal         @default(0) @db.Decimal(10, 2)
  finalCost         Decimal         @default(0) @db.Decimal(10, 2)
  paidAmount        Decimal         @default(0) @db.Decimal(10, 2)
  customerId        String
  customer          Customer        @relation(fields: [customerId], references: [id])
  deviceId          String
  device            Device          @relation(fields: [deviceId], references: [id])
  storeId           String
  store             Store           @relation(fields: [storeId], references: [id])
  createdById       String
  createdBy         User            @relation("CreatedBy", fields: [createdById], references: [id])
  assignedToId      String?
  assignedTo        User?           @relation("AssignedTo", fields: [assignedToId], references: [id])
  checklist         ChecklistItem[]
  photos            Photo[]
  partsUsed         PartUsage[]
  internalPhotos    Photo[]         @relation("InternalPhotos")
  timeEntries       TimeEntry[]
  qaResult          QAResult?
  invoice           Invoice?
  safeKitId         String?         @unique
  safeKit           SafeKit?        @relation(fields: [safeKitId], references: [id])
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  completedAt       DateTime?
  @@map("service_orders")
}

model ChecklistItem {
  id          String       @id @default(uuid())
  category    String
  item        String
  checked     Boolean      @default(false)
  notes       String?
  orderId     String
  order       ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  @@map("checklist_items")
}

model Photo {
  id              String        @id @default(uuid())
  url             String
  type            String
  description     String?
  orderId         String
  order           ServiceOrder  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  internalOrderId String?
  internalOrder   ServiceOrder? @relation("InternalPhotos", fields: [internalOrderId], references: [id])
  uploadedAt      DateTime      @default(now())
  @@map("photos")
}

model Part {
  id                String          @id @default(uuid())
  sku               String          @unique
  name              String
  description       String?
  category          String
  compatibleModels  String[]
  costPrice         Decimal         @db.Decimal(10, 2)
  salePrice         Decimal         @db.Decimal(10, 2)
  shippingCost      Decimal         @default(0) @db.Decimal(10, 2)
  operationalCost   Decimal         @default(0) @db.Decimal(10, 2)
  warrantyFund      Decimal         @default(0) @db.Decimal(10, 2)
  minStock          Int             @default(3)
  supplier          String?
  stock             PartStock[]
  transfers         StockTransfer[]
  usages            PartUsage[]
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  @@map("parts")
}

model PartStock {
  id        String @id @default(uuid())
  quantity  Int    @default(0)
  reserved  Int    @default(0)
  partId    String
  part      Part   @relation(fields: [partId], references: [id])
  storeId   String
  store     Store  @relation(fields: [storeId], references: [id])
  @@unique([partId, storeId])
  @@map("part_stocks")
}

model StockTransfer {
  id            String         @id @default(uuid())
  quantity      Int
  status        TransferStatus @default(PENDING)
  partId        String
  part          Part           @relation(fields: [partId], references: [id])
  fromStoreId   String
  fromStore     Store          @relation("FromTransfer", fields: [fromStoreId], references: [id])
  toStoreId     String
  toStore       Store          @relation("ToTransfer", fields: [toStoreId], references: [id])
  requestedBy   String
  approvedBy    String?
  sentAt        DateTime?
  receivedAt    DateTime?
  createdAt     DateTime       @default(now())
  @@map("stock_transfers")
}

model PartUsage {
  id        String       @id @default(uuid())
  quantity  Int
  costPrice Decimal      @db.Decimal(10, 2)
  salePrice Decimal      @db.Decimal(10, 2)
  partId    String
  part      Part         @relation(fields: [partId], references: [id])
  orderId   String
  order     ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  @@map("part_usages")
}

model TimeEntry {
  id           String       @id @default(uuid())
  startTime    DateTime
  endTime      DateTime?
  duration     Int?
  description  String
  technicianId String
  technician   User         @relation(fields: [technicianId], references: [id])
  orderId      String
  order        ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  @@map("time_entries")
}

model QAResult {
  id        String       @id @default(uuid())
  passed    Boolean
  testDate  DateTime     @default(now())
  notes     String?
  orderId   String       @unique
  order     ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  testedBy  String
  tests     QATest[]
  @@map("qa_results")
}

model QATest {
  id          String   @id @default(uuid())
  name        String
  passed      Boolean  @default(false)
  notes       String?
  qaResultId  String
  qaResult    QAResult @relation(fields: [qaResultId], references: [id], onDelete: Cascade)
  @@map("qa_tests")
}

model SafeKit {
  id            String        @id @default(uuid())
  code          String        @unique
  name          String
  qrCode        String
  status        String        @default("available")
  storeId       String
  store         Store         @relation(fields: [storeId], references: [id])
  currentOrder  ServiceOrder?
  createdAt     DateTime      @default(now())
  @@map("safe_kits")
}

model CourtesyDevice {
  id            String       @id @default(uuid())
  type          DeviceType
  brand         DeviceBrand
  model         String
  serialNumber  String       @unique
  status        String       @default("available")
  storeId       String
  store         Store        @relation(fields: [storeId], references: [id])
  loans         DeviceLoan[]
  createdAt     DateTime     @default(now())
  @@map("courtesy_devices")
}

model DeviceLoan {
  id                 String         @id @default(uuid())
  loanDate           DateTime       @default(now())
  expectedReturnDate DateTime
  actualReturnDate   DateTime?
  condition          String
  notes              String?
  deviceId           String
  device             CourtesyDevice @relation(fields: [deviceId], references: [id])
  customerId         String
  customer           Customer       @relation(fields: [customerId], references: [id])
  orderId            String
  @@map("device_loans")
}

model Invoice {
  id             String         @id @default(uuid())
  invoiceNumber  String         @unique
  subtotal       Decimal        @db.Decimal(10, 2)
  igtfAmount     Decimal        @default(0) @db.Decimal(10, 2)
  discount       Decimal        @default(0) @db.Decimal(10, 2)
  total          Decimal        @db.Decimal(10, 2)
  totalVES       Decimal        @db.Decimal(10, 2)
  paidTotal      Decimal        @default(0) @db.Decimal(10, 2)
  status         InvoiceStatus  @default(PENDING)
  customerId     String
  customer       Customer       @relation(fields: [customerId], references: [id])
  storeId        String
  store          Store          @relation(fields: [storeId], references: [id])
  orderId        String?        @unique
  order          ServiceOrder?  @relation(fields: [orderId], references: [id])
  items          InvoiceItem[]
  payments       Payment[]
  createdBy      String
  createdAt      DateTime       @default(now())
  paidAt         DateTime?
  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(uuid())
  type        String
  description String
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  @@map("invoice_items")
}

model Payment {
  id          String        @id @default(uuid())
  method      PaymentMethod
  amount      Decimal       @db.Decimal(10, 2)
  amountVES   Decimal?      @db.Decimal(10, 2)
  reference   String?
  bankName    String?
  phoneNumber String?
  email       String?
  timestamp   DateTime      @default(now())
  invoiceId   String
  invoice     Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  @@map("payments")
}

model CashRegister {
  id              String             @id @default(uuid())
  openingUSD      Decimal            @db.Decimal(10, 2)
  openingVES      Decimal            @db.Decimal(10, 2)
  declaredUSD     Decimal?           @db.Decimal(10, 2)
  declaredVES     Decimal?           @db.Decimal(10, 2)
  systemUSD       Decimal            @db.Decimal(10, 2)
  systemVES       Decimal            @db.Decimal(10, 2)
  discrepancyUSD  Decimal?           @db.Decimal(10, 2)
  discrepancyVES  Decimal?           @db.Decimal(10, 2)
  status          RegisterStatus
  storeId         String
  store           Store              @relation(fields: [storeId], references: [id])
  openedById      String
  openedBy        User               @relation(fields: [openedById], references: [id])
  closedById      String?
  expenses        PettyCashExpense[]
  openedAt        DateTime           @default(now())
  closedAt        DateTime?
  @@map("cash_registers")
}

model PettyCashExpense {
  id           String       @id @default(uuid())
  description  String
  amount       Decimal      @db.Decimal(10, 2)
  currency     String
  category     String
  receiptPhoto String?
  registerId   String
  register     CashRegister @relation(fields: [registerId], references: [id], onDelete: Cascade)
  createdBy    String
  createdAt    DateTime     @default(now())
  @@map("petty_cash_expenses")
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String
  entityType  String
  entityId    String
  oldValue    Json?
  newValue    Json?
  ipAddress   String
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  timestamp   DateTime @default(now())
  @@map("audit_logs")
}

model WhatsAppTemplate {
  id          String   @id @default(uuid())
  name        String
  trigger     String
  content     String
  variables   String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@map("whatsapp_templates")
}

model AppSetting {
  id                      String   @id @default(uuid())
  companyName             String   @default("SERVISTECH")
  defaultWarrantyDays     Int      @default(90)
  igtfPercentage          Decimal  @default(3) @db.Decimal(5, 2)
  warrantyFundPercentage  Decimal  @default(10) @db.Decimal(5, 2)
  bcvAutoSync             Boolean  @default(true)
  bcvSyncHour             Int      @default(8)
  whatsappEnabled         Boolean  @default(true)
  updatedAt               DateTime @updatedAt
  @@map("app_settings")
}