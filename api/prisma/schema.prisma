// SERVISTECH ERP V4.0 - SCHEMA FINAL OPTIMIZADO
// Multi-Tenancy con RLS + Comisiones + Soporte para Railway (OpenSSL)

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  SUPER_ADMIN
  GERENTE
  ENCARGADA
  ANFITRION
  TECNICO
  QA
  ALMACEN
  MENSAJERO
  CLIENTE
}

enum OrderStatus {
  TRIAJE
  DIAGNOSTICO
  ESPERA_REPUESTO
  MICRO_SOLDADURA
  QA
  LISTO
  ENTREGADO
  GARANTIA
}

enum WarrantyStatus {
  PENDIENTE
  APROBADA
  RECHAZADA
  EN_REPARACION
  COMPLETADA
  CANCELADA
}

enum WarrantyCause {
  ERROR_HUMANO
  REPUESTO_DEFECTUOSO
  FALLA_REINCIDENTE
  DANO_USUARIO
  OTRO
}

enum Priority {
  BAJA
  MEDIA
  ALTA
  URGENTE
  GARANTIA
}

enum DeviceType {
  IPHONE
  IPAD
  ANDROID
  WATCH
  LAPTOP
  OTHER
}

enum DeviceBrand {
  APPLE
  SAMSUNG
  XIAOMI
  MOTOROLA
  HUAWEI
  OTHER
}

enum LockType {
  NONE
  PATTERN
  PIN
  PASSWORD
  FACE_ID
  FINGERPRINT
}

enum PaymentMethod {
  ZELLE
  CASH_USD
  CASH_VES
  PAGO_MOVIL
  BINANCE
  TRANSFER
}

enum InvoiceStatus {
  PENDING
  PAID
  PARTIAL
  CANCELLED
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

enum RegisterStatus {
  OPEN
  CLOSED
  DISCREPANCY
}

enum PartType {
  REPUESTO
  ACCESORIO
}

enum CommissionStatus {
  PENDIENTE
  APROBADA
  PAGADA
  DEBITADA
}

enum DebitReason {
  DANO_ACCIDENTAL
  REPUESTO_ROTO
  ERROR_REPARACION
  PERDIDA_EQUIPO
  OTRO
}

enum ExpenseCategory {
  ALQUILER
  NOMINA
  SERVICIOS
  SUMINISTROS
  MANTENIMIENTO
  OTROS
}

// ==================== MODELOS CORE ====================

model User {
  id              String    @id @default(uuid())
  name            String
  email           String    @unique
  password        String
  role            UserRole  @default(ANFITRION)
  isActive        Boolean   @default(true)
  avatar          String?
  
  commissionRate  Decimal   @default(35) @db.Decimal(5, 2)
  flatRatePerUnit Decimal   @default(1) @db.Decimal(12, 2)
  accessoryRate   Decimal   @default(10) @db.Decimal(5, 2)
  
  storeId         String
  store           Store     @relation(fields: [storeId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLogin       DateTime?
  
  ordersCreated   ServiceOrder[]   @relation("CreatedBy")
  ordersAssigned  ServiceOrder[]   @relation("AssignedTo")
  timeEntries     TimeEntry[]
  cashRegisters   CashRegister[]
  auditLogs       AuditLog[]
  commissions     Commission[]
  debits          TechnicianDebit[]
  
  @@map("users")
  @@index([storeId])
}

model Store {
  id              String     @id @default(uuid())
  name            String
  code            String     @unique
  address         String
  phone           String
  email           String
  logo            String?
  isActive        Boolean    @default(true)
  
  rif             String?
  razonSocial     String?
  direccionFiscal String?
  
  users           User[]
  orders          ServiceOrder[]
  parts           PartStock[]
  cashRegisters   CashRegister[]
  safeKits        SafeKit[]
  courtesyDevices CourtesyDevice[]
  invoices        Invoice[]
  warranties      WarrantyClaim[]
  expenses        FixedExpense[]
  dailyTargets    DailyTarget[]

  // Relaciones inversas corregidas para transferencias entre tiendas
  transfersFrom   StockTransfer[] @relation("FromStore")
  transfersTo     StockTransfer[] @relation("ToStore")
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@map("stores")
}

model BCVRate {
  id          String    @id @default(uuid())
  rate        Decimal   @db.Decimal(15, 4)
  date        DateTime  @default(now())
  source      String
  updatedBy   String?
  isBackup    Boolean   @default(false)
  
  createdAt   DateTime  @default(now())
  
  @@map("bcv_rates")
  @@index([date])
}

model BinanceRate {
  id          String    @id @default(uuid())
  rate        Decimal   @db.Decimal(15, 4)
  usdtPrice   Decimal   @db.Decimal(10, 4)
  date        DateTime  @default(now())
  source      String
  
  createdAt   DateTime  @default(now())
  
  @@map("binance_rates")
  @@index([date])
}

model Customer {
  id           String    @id @default(uuid())
  name         String
  email        String?
  phone        String
  documentId