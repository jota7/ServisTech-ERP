generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum UserRole {
  SUPER_ADMIN
  GERENTE
  ENCARGADA
  ANFITRION
  TECNICO
  QA
  ALMACEN
  MENSAJERO
  CLIENTE
}

enum OrderStatus {
  TRIAJE
  DIAGNOSTICO
  ESPERA_REPUESTO
  MICRO_SOLDADURA
  QA
  LISTO
  ENTREGADO
  GARANTIA
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

enum PartType {
  REPUESTO
  ACCESORIO
}

// --- MODELS ---

model User {
  id              String    @id @default(uuid())
  name            String
  email           String    @unique
  password        String
  role            UserRole  @default(ANFITRION)
  storeId         String
  store           Store     @relation(fields: [storeId], references: [id])
  ordersCreated   ServiceOrder[]   @relation("CreatedBy")
  ordersAssigned  ServiceOrder[]   @relation("AssignedTo")
  timeEntries     TimeEntry[]
  
  @@map("users")
}

model Store {
  id              String     @id @default(uuid())
  name            String
  code            String     @unique
  users           User[]
  orders          ServiceOrder[]
  parts           PartStock[]
  safeKits        SafeKit[]
  transfersFrom   StockTransfer[] @relation("FromStore")
  transfersTo     StockTransfer[] @relation("ToStore")
  
  @@map("stores")
}

model Customer {
  id           String    @id @default(uuid())
  name         String
  phone        String
  documentId   String    @unique
  devices      Device[]
  orders       ServiceOrder[]
  
  @@map("customers")
}

model Device {
  id           String       @id @default(uuid())
  model        String
  serialNumber String
  customerId   String
  customer     Customer     @relation(fields: [customerId], references: [id])
  orders       ServiceOrder[]
  
  @@map("devices")
}

model ServiceOrder {
  id                String       @id @default(uuid())
  orderNumber       String       @unique
  status            OrderStatus  @default(TRIAJE)
  
  customerId        String
  customer          Customer     @relation(fields: [customerId], references: [id])
  deviceId          String
  device            Device       @relation(fields: [deviceId], references: [id])
  storeId           String
  store             Store        @relation(fields: [storeId], references: [id])
  createdById       String
  createdBy         User         @relation("CreatedBy", fields: [createdById], references: [id])
  assignedToId      String?
  assignedTo        User?        @relation("AssignedTo", fields: [assignedToId], references: [id])
  
  checklist         ChecklistItem[]
  photos            Photo[]
  partsUsed         PartUsage[]
  internalPhotos    Photo[]       @relation("InternalPhotos")
  timeEntries       TimeEntry[]
  qaResult          QAResult?
  invoice           Invoice?
  warranty          WarrantyClaim?
  commission        Commission?
  
  safeKitId         String?       @unique
  safeKit           SafeKit?      @relation(fields: [safeKitId], references: [id])
  
  createdAt         DateTime      @default(now())
  @@map("service_orders")
}

model Category {
  id          String    @id @default(uuid())
  name        String
  parts       Part[]
  @@map("categories")
}

model Part {
  id                String       @id @default(uuid())
  sku               String       @unique
  name              String
  categoryId        String
  category          Category     @relation(fields: [categoryId], references: [id])
  stock             PartStock[]
  usages            PartUsage[]
  transfers         StockTransfer[] 
  @@map("parts")
}

model PartStock {
  id        String   @id @default(uuid())
  quantity  Int      @default(0)
  partId    String
  part      Part     @relation(fields: [partId], references: [id])
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])
  @@unique([partId, storeId])
}

model StockTransfer {
  id            String         @id @default(uuid())
  quantity      Int
  status        TransferStatus @default(PENDING)
  partId        String
  part          Part           @relation(fields: [partId], references: [id])
  fromStoreId   String
  fromStore     Store          @relation("FromStore", fields: [fromStoreId], references: [id])
  toStoreId     String
  toStore       Store          @relation("ToStore", fields: [toStoreId], references: [id])
}

model PartUsage {
  id          String       @id @default(uuid())
  partId      String
  part        Part         @relation(fields: [partId], references: [id])
  orderId     String
  order       ServiceOrder @relation(fields: [orderId], references: [id])
}

model ChecklistItem {
  id          String       @id @default(uuid())
  orderId     String
  order       ServiceOrder @relation(fields: [orderId], references: [id])
}

model Photo {
  id          String       @id @default(uuid())
  orderId     String
  order       ServiceOrder @relation(fields: [orderId], references: [id])
  internalOrderId String?
  internalOrder   ServiceOrder? @relation("InternalPhotos", fields: [internalOrderId], references: [id])
}

model TimeEntry {
  id           String       @id @default(uuid())
  technicianId String
  technician   User         @relation(fields: [technicianId], references: [id])
  orderId      String
  order       ServiceOrder @relation(fields: [orderId], references: [id])
}

model QAResult {
  id          String       @id @default(uuid())
  orderId     String       @unique
  order       ServiceOrder @relation(fields: [orderId], references: [id])
}

model Commission {
  id              String           @id @default(uuid())
  orderId         String           @unique
  order           ServiceOrder     @relation(fields: [orderId], references: [id])
}

model SafeKit {
  id              String          @id @default(uuid())
  code            String          @unique
  storeId         String
  store           Store           @relation(fields: [storeId], references: [id])
  currentOrder    ServiceOrder?
}

model Invoice {
  id              String         @id @default(uuid())
  orderId         String?        @unique
  order           ServiceOrder?  @relation(fields: [orderId], references: [id])
}

model WarrantyClaim {
  id              String         @id @default(uuid())
  originalOrderId String         @unique
  originalOrder   ServiceOrder   @relation(fields: [originalOrderId], references: [id])
}