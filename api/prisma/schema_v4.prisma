// SERVISTECH ERP V4.0 - SCHEMA COMPLETO
// Multi-Tenancy con Row Level Security + Garantías + Comisiones + Omnicanalidad

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  SUPER_ADMIN    // Acceso total a todas las sedes
  GERENTE        // Gestión de sede asignada
  ENCARGADA      // $1 por equipo + 10% accesorios
  ANFITRION      // Recepción
  TECNICO        // 35% utilidad bruta + cola personal
  QA             // Control de calidad
  ALMACEN        // Gestión de inventario
  MENSAJERO      // App móvil - logística
  CLIENTE        // Portal web clientes
}

enum OrderStatus {
  TRIAJE
  DIAGNOSTICO
  ESPERA_REPUESTO
  MICRO_SOLDADURA
  QA
  LISTO
  ENTREGADO
  GARANTIA
}

enum WarrantyStatus {
  PENDIENTE      // Esperando revisión
  APROBADA       // Aprobada para reparación
  RECHAZADA      // No cubre garantía
  EN_REPARACION  // En proceso
  COMPLETADA     // Finalizada
  CANCELADA
}

enum WarrantyCause {
  ERROR_HUMANO           // Falla del técnico
  REPUESTO_DEFECTUOSO    // Pieza mala
  FALLA_REINCIDENTE      // Mismo problema
  DAÑO_USUARIO           // Culpa del cliente
  OTRO
}

enum Priority {
  BAJA
  MEDIA
  ALTA
  URGENTE
  GARANTIA   // Carril prioritario en Kanban
}

enum DeviceType {
  IPHONE
  IPAD
  ANDROID
  WATCH
  LAPTOP
  OTHER
}

enum DeviceBrand {
  APPLE
  SAMSUNG
  XIAOMI
  MOTOROLA
  HUAWEI
  OTHER
}

enum LockType {
  NONE
  PATTERN
  PIN
  PASSWORD
  FACE_ID
  FINGERPRINT
}

enum PaymentMethod {
  ZELLE
  CASH_USD
  CASH_VES
  PAGO_MOVIL
  BINANCE
  TRANSFER
}

enum InvoiceStatus {
  PENDING
  PAID
  PARTIAL
  CANCELLED
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

enum RegisterStatus {
  OPEN
  CLOSED
  DISCREPANCY
}

enum PartType {
  REPUESTO     // Para reparaciones técnicas
  ACCESORIO    // Para venta POS/Web
}

enum CommissionStatus {
  PENDIENTE
  APROBADA
  PAGADA
  DEBITADA     // Tiene contra-cargos
}

enum DebitReason {
  DANO_ACCIDENTAL
  REPUESTO_ROTO
  ERROR_REPARACION
  PERDIDA_EQUIPO
  OTRO
}

enum ExpenseCategory {
  ALQUILER
  NOMINA
  SERVICIOS
  SUMINISTROS
  MANTENIMIENTO
  OTROS
}

// ==================== MODELOS CORE ====================

model User {
  id              String    @id @default(uuid())
  name            String
  email           String    @unique
  password        String
  role            UserRole  @default(ANFITRION)
  isActive        Boolean   @default(true)
  avatar          String?
  
  // Comisión configurable por empleado
  commissionRate  Decimal   @default(35) @db.Decimal(5, 2) // % para técnicos
  flatRatePerUnit Decimal   @default(1) @db.Decimal(10, 2)  // $ por equipo (encargadas)
  accessoryRate   Decimal   @default(10) @db.Decimal(5, 2)  // % sobre accesorios
  
  // Multi-tenancy
  storeId         String
  store           Store     @relation(fields: [storeId], references: [id])
  
  // Auditoría
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLogin       DateTime?
  
  // Relaciones
  ordersCreated   ServiceOrder[]   @relation("CreatedBy")
  ordersAssigned  ServiceOrder[]   @relation("AssignedTo")
  timeEntries     TimeEntry[]
  cashRegisters   CashRegister[]
  auditLogs       AuditLog[]
  commissions     Commission[]
  debits          TechnicianDebit[]
  
  @@map("users")
  @@index([storeId])
}

model Store {
  id              String     @id @default(uuid())
  name            String
  code            String     @unique
  address         String
  phone           String
  email           String
  logo            String?
  isActive        Boolean    @default(true)
  
  // Fiscal
  rif             String?
  razonSocial     String?
  direccionFiscal String?
  
  // Relaciones
  users           User[]
  orders          ServiceOrder[]
  parts           PartStock[]
  cashRegisters   CashRegister[]
  safeKits        SafeKit[]
  courtesyDevices CourtesyDevice[]
  invoices        Invoice[]
  warranties      WarrantyClaim[]
  expenses        FixedExpense[]
  dailyTargets    DailyTarget[]
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@map("stores")
}

// ==================== TASAS Y FINANZAS ====================

model BCVRate {
  id          String    @id @default(uuid())
  rate        Decimal   @db.Decimal(15, 4)
  date        DateTime  @default(now())
  source      String    // 'automatic' | 'manual' | 'cached'
  updatedBy   String?   // Usuario que forzó manual
  isBackup    Boolean   @default(false) // Si es valor de respaldo
  
  createdAt   DateTime  @default(now())
  
  @@map("bcv_rates")
  @@index([date])
}

model BinanceRate {
  id          String    @id @default(uuid())
  rate        Decimal   @db.Decimal(15, 4)
  usdtPrice   Decimal   @db.Decimal(10, 4) // Precio USDT/USD
  date        DateTime  @default(now())
  source      String    // 'api' | 'manual' | 'cached'
  
  createdAt   DateTime  @default(now())
  
  @@map("binance_rates")
  @@index([date])
}

// ==================== CLIENTES Y DISPOSITIVOS ====================

model Customer {
  id          String    @id @default(uuid())
  name        String
  email       String?
  phone       String
  documentId  String    @unique
  address     String?
  
  // Portal cliente
  password    String?   // Para login en portal
  isPortalUser Boolean @default(false)
  
  // Relaciones
  devices     Device[]
  orders      ServiceOrder[]
  invoices    Invoice[]
  loans       DeviceLoan[]
  deliveries  DeliveryRequest[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("customers")
}

model Device {
  id            String       @id @default(uuid())
  type          DeviceType
  brand         DeviceBrand
  model         String
  serialNumber  String
  imei          String?
  color         String?
  storage       String?
  notes         String?
  
  // Credenciales de seguridad (V4.0)
  lockType      LockType     @default(NONE)
  pattern       Int[]        // Array de índices [0-8] para patrón
  pin           String?      // Hash del PIN
  password      String?      // Hash de contraseña
  credentialsNote String?    // Notas adicionales
  
  // Relaciones
  customerId    String
  customer      Customer     @relation(fields: [customerId], references: [id])
  orders        ServiceOrder[]
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@map("devices")
}

// ==================== ÓRDENES DE SERVICIO ====================

model ServiceOrder {
  id              String       @id @default(uuid())
  orderNumber     String       @unique
  status          OrderStatus  @default(TRIAJE)
  priority        Priority     @default(MEDIA)
  
  // Recepción
  reportedIssue   String
  termsAccepted   Boolean      @default(false)
  customerSignature String?
  
  // Técnico
  diagnosis       String?
  solution        String?
  
  // Financiero
  estimatedCost   Decimal      @default(0) @db.Decimal(12, 2)
  finalCost       Decimal      @default(0) @db.Decimal(12, 2)
  paidAmount      Decimal      @default(0) @db.Decimal(12, 2)
  
  // COGS+ - Costo total con garantía incluida
  totalCost       Decimal      @default(0) @db.Decimal(12, 2)
  grossProfit     Decimal      @default(0) @db.Decimal(12, 2) // Utilidad bruta
  
  // Multi-tenancy
  customerId      String
  customer        Customer     @relation(fields: [customerId], references: [id])
  deviceId        String
  device          Device       @relation(fields: [deviceId], references: [id])
  storeId         String
  store           Store        @relation(fields: [storeId], references: [id])
  
  createdById     String
  createdBy       User         @relation("CreatedBy", fields: [createdById], references: [id])
  assignedToId    String?
  assignedTo      User?        @relation("AssignedTo", fields: [assignedToId], references: [id])
  
  // Relaciones
  checklist       ChecklistItem[]
  photos          Photo[]
  partsUsed       PartUsage[]
  internalPhotos  Photo[]       @relation("InternalPhotos")
  timeEntries     TimeEntry[]
  qaResult        QAResult?
  invoice         Invoice?
  warranty        WarrantyClaim?
  commission      Commission?
  
  // Logística
  safeKitId       String?
  safeKit         SafeKit?      @relation(fields: [safeKitId], references: [id])
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  completedAt     DateTime?
  
  @@map("service_orders")
  @@index([storeId])
  @@index([status])
  @@index([assignedToId])
}

model ChecklistItem {
  id          String       @id @default(uuid())
  category    String
  item        String
  checked     Boolean      @default(false)
  notes       String?
  
  orderId     String
  order       ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("checklist_items")
}

model Photo {
  id          String       @id @default(uuid())
  url         String       // URL de S3/Cloudinary
  type        String       // 'exterior' | 'interior' | 'document' | 'delivery' | 'warranty'
  description String?
  
  orderId     String
  order       ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  internalOrderId String?
  internalOrder   ServiceOrder? @relation("InternalPhotos", fields: [internalOrderId], references: [id])
  
  uploadedAt  DateTime     @default(now())
  
  @@map("photos")
}

// ==================== GARANTÍAS (V4.0) ====================

model WarrantyClaim {
  id              String         @id @default(uuid())
  warrantyNumber  String         @unique
  status          WarrantyStatus @default(PENDIENTE)
  
  // Vinculación a orden original
  originalOrderId String         @unique
  originalOrder   ServiceOrder   @relation(fields: [originalOrderId], references: [id])
  
  // Causa de la garantía
  cause           WarrantyCause
  causeNotes      String?        // Detalle de la causa
  isHumanError    Boolean        @default(false)
  
  // Diagnóstico de garantía
  diagnosis       String?
  solution        String?
  
  // Costos (pueden ser diferentes a orden original)
  estimatedCost   Decimal        @default(0) @db.Decimal(12, 2)
  finalCost       Decimal        @default(0) @db.Decimal(12, 2)
  
  // Multi-tenancy
  storeId         String
  store           Store          @relation(fields: [storeId], references: [id])
  
  // Auditoría
  createdById     String
  approvedById    String?
  approvedAt      DateTime?
  
  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  completedAt     DateTime?
  
  @@map("warranty_claims")
  @@index([storeId])
  @@index([status])
}

// ==================== INVENTARIO SEGREGADO ====================

model Category {
  id          String    @id @default(uuid())
  name        String
  description String?
  color       String    @default("#39FF14")
  
  // Relaciones
  parts       Part[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("categories")
}

model Part {
  id                String       @id @default(uuid())
  sku               String       @unique
  name              String
  description       String?
  
  // Clasificación segregada (V4.0)
  partType          PartType     @default(REPUESTO)
  categoryId        String
  category          Category     @relation(fields: [categoryId], references: [id])
  compatibleModels  String[]
  
  // Pricing
  costPrice         Decimal      @db.Decimal(12, 2)
  salePrice         Decimal      @db.Decimal(12, 2)
  shippingCost      Decimal      @default(0) @db.Decimal(12, 2)
  operationalCost   Decimal      @default(0) @db.Decimal(12, 2)
  warrantyFund      Decimal      @default(0) @db.Decimal(12, 2)
  
  // Stock
  minStock          Int          @default(3)
  supplier          String?
  
  // Relaciones
  stock             PartStock[]
  transfersFrom     StockTransfer[] @relation("FromTransfer")
  transfersTo       StockTransfer[] @relation("ToTransfer")
  usages            PartUsage[]
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  @@map("parts")
  @@index([partType])
  @@index([categoryId])
}

model PartStock {
  id        String   @id @default(uuid())
  quantity  Int      @default(0)
  reserved  Int      @default(0)
  
  partId    String
  part      Part     @relation(fields: [partId], references: [id])
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])
  
  @@unique([partId, storeId])
  @@map("part_stocks")
  @@index([storeId])
}

model StockTransfer {
  id            String         @id @default(uuid())
  quantity      Int
  status        TransferStatus @default(PENDING)
  
  partId        String
  part          Part           @relation(fields: [partId], references: [id])
  fromStoreId   String
  fromStore     Store          @relation("FromTransfer", fields: [fromStoreId], references: [id])
  toStoreId     String
  toStore       Store          @relation("ToTransfer", fields: [toStoreId], references: [id])
  
  requestedBy   String
  approvedBy    String?
  
  sentAt        DateTime?
  receivedAt    DateTime?
  createdAt     DateTime       @default(now())
  
  @@map("stock_transfers")
}

model PartUsage {
  id          String       @id @default(uuid())
  quantity    Int
  costPrice   Decimal      @db.Decimal(12, 2)
  salePrice   Decimal      @db.Decimal(12, 2)
  
  partId      String
  part        Part         @relation(fields: [partId], references: [id])
  orderId     String
  order       ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("part_usages")
}

// ==================== TIEMPO Y QA ====================

model TimeEntry {
  id          String       @id @default(uuid())
  startTime   DateTime
  endTime     DateTime?
  duration    Int?         // en minutos
  description String
  
  technicianId String
  technician   User         @relation(fields: [technicianId], references: [id])
  orderId      String
  order        ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("time_entries")
}

model QAResult {
  id          String       @id @default(uuid())
  passed      Boolean
  testDate    DateTime     @default(now())
  notes       String?
  
  orderId     String       @unique
  order       ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  testedBy    String
  
  tests       QATest[]
  
  @@map("qa_results")
}

model QATest {
  id          String       @id @default(uuid())
  name        String
  passed      Boolean      @default(false)
  notes       String?
  
  qaResultId  String
  qaResult    QAResult     @relation(fields: [qaResultId], references: [id], onDelete: Cascade)
  
  @@map("qa_tests")
}

// ==================== COMISIONES Y DÉBITOS (V4.0) ====================

model Commission {
  id              String           @id @default(uuid())
  
  // Vinculación a orden
  orderId         String           @unique
  order           ServiceOrder     @relation(fields: [orderId], references: [id])
  
  // Cálculos
  grossProfit     Decimal          @db.Decimal(12, 2)  // Utilidad bruta
  commissionRate  Decimal          @db.Decimal(5, 2)   // % aplicado
  amount          Decimal          @db.Decimal(12, 2)  // Monto de comisión
  
  // Para encargadas: $1 por equipo
  flatRateAmount  Decimal          @default(0) @db.Decimal(12, 2)
  
  // Estado
  status          CommissionStatus @default(PENDIENTE)
  
  // Contra-cargos
  debits          TechnicianDebit[]
  totalDebits     Decimal          @default(0) @db.Decimal(12, 2)
  netAmount       Decimal          @db.Decimal(12, 2)  // Monto final
  
  // Relaciones
  technicianId    String
  technician      User             @relation(fields: [technicianId], references: [id])
  
  // Período
  periodMonth     Int
  periodYear      Int
  
  // Pago
  paidAt          DateTime?
  paidBy          String?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  @@map("commissions")
  @@index([technicianId])
  @@index([periodMonth, periodYear])
}

model TechnicianDebit {
  id              String       @id @default(uuid())
  
  // Vinculación a comisión
  commissionId    String
  commission      Commission   @relation(fields: [commissionId], references: [id])
  
  // Detalle del débito
  reason          DebitReason
  description     String
  amount          Decimal      @db.Decimal(12, 2)
  
  // Evidencia
  photos          String[]     // URLs de fotos
  
  // Responsable
  technicianId    String
  technician      User         @relation(fields: [technicianId], references: [id])
  
  // Aprobación
  approvedById    String?
  approvedAt      DateTime?
  
  createdAt       DateTime     @default(now())
  
  @@map("technician_debits")
  @@index([technicianId])
}

// ==================== METAS Y GASTOS (V4.0) ====================

model FixedExpense {
  id          String          @id @default(uuid())
  name        String
  amount      Decimal         @db.Decimal(12, 2)
  category    ExpenseCategory
  
  // Recurrencia
  isRecurring Boolean         @default(true)
  dayOfMonth  Int?            // Día de cobro (para recurrentes)
  
  // Multi-tenancy
  storeId     String
  store       Store           @relation(fields: [storeId], references: [id])
  
  // Estado
  isActive    Boolean         @default(true)
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  @@map("fixed_expenses")
  @@index([storeId])
}

model DailyTarget {
  id              String    @id @default(uuid())
  date            DateTime
  
  // Metas
  targetAmount    Decimal   @db.Decimal(12, 2)
  actualAmount    Decimal   @default(0) @db.Decimal(12, 2)
  
  // Gastos del día
  fixedExpenses   Decimal   @default(0) @db.Decimal(12, 2)
  pettyCashTotal  Decimal   @default(0) @db.Decimal(12, 2)
  
  // Cálculo
  netTarget       Decimal   @db.Decimal(12, 2)  // Meta - Gastos
  isMet           Boolean   @default(false)
  
  // Multi-tenancy
  storeId         String
  store           Store     @relation(fields: [storeId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([date, storeId])
  @@map("daily_targets")
  @@index([storeId])
}

// ==================== LOGÍSTICA ====================

model SafeKit {
  id              String          @id @default(uuid())
  code            String          @unique
  name            String
  qrCode          String
  status          String          @default("available")
  
  storeId         String
  store           Store           @relation(fields: [storeId], references: [id])
  
  currentOrderId  String?         @unique
  currentOrder    ServiceOrder?   @relation(fields: [currentOrderId], references: [id])
  
  createdAt       DateTime        @default(now())
  
  @@map("safe_kits")
}

model CourtesyDevice {
  id            String       @id @default(uuid())
  type          DeviceType
  brand         DeviceBrand
  model         String
  serialNumber  String       @unique
  status        String       @default("available")
  
  storeId       String
  store         Store        @relation(fields: [storeId], references: [id])
  
  loans         DeviceLoan[]
  
  createdAt     DateTime     @default(now())
  
  @@map("courtesy_devices")
}

model DeviceLoan {
  id                String         @id @default(uuid())
  loanDate          DateTime       @default(now())
  expectedReturnDate DateTime
  actualReturnDate  DateTime?
  condition         String
  notes             String?
  
  deviceId          String
  device            CourtesyDevice @relation(fields: [deviceId], references: [id])
  customerId        String
  customer          Customer       @relation(fields: [customerId], references: [id])
  orderId           String
  
  @@map("device_loans")
}

// ==================== DELIVERY / PORTAL CLIENTE (V4.0) ====================

model DeliveryRequest {
  id              String    @id @default(uuid())
  
  // Cliente
  customerId      String
  customer        Customer  @relation(fields: [customerId], references: [id])
  
  // Ubicación
  address         String
  latitude        Decimal?  @db.Decimal(10, 8)
  longitude       Decimal?  @db.Decimal(11, 8)
  
  // Equipo
  deviceType      DeviceType
  deviceModel     String
  deviceColor     String?
  serialNumber    String?
  imei            String?
  
  // Credenciales
  lockType        LockType  @default(NONE)
  pattern         Int[]
  pin             String?
  password        String?
  
  // Problema
  issue           String
  photos          String[]  // URLs de fotos del equipo
  
  // Estado
  status          String    @default("pending") // pending | confirmed | picked_up | delivered
  
  // Asignación
  messengerId     String?
  
  // Timestamps
  requestedAt     DateTime  @default(now())
  scheduledDate   DateTime?
  completedAt     DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("delivery_requests")
  @@index([customerId])
  @@index([status])
}

// ==================== FACTURACIÓN ====================

model Invoice {
  id              String         @id @default(uuid())
  invoiceNumber   String         @unique
  
  // Totales
  subtotal        Decimal        @db.Decimal(12, 2)
  igtfAmount      Decimal        @default(0) @db.Decimal(12, 2)
  discount        Decimal        @default(0) @db.Decimal(12, 2)
  total           Decimal        @db.Decimal(12, 2)
  totalVES        Decimal        @db.Decimal(12, 2)
  
  // Tasa usada
  rateType        String         @default("bcv") // 'bcv' | 'binance'
  rateValue       Decimal        @db.Decimal(15, 4)
  
  // Pagos
  paidTotal       Decimal        @default(0) @db.Decimal(12, 2)
  status          InvoiceStatus  @default(PENDING)
  
  // Relaciones
  customerId      String
  customer        Customer       @relation(fields: [customerId], references: [id])
  storeId         String
  store           Store          @relation(fields: [storeId], references: [id])
  orderId         String?        @unique
  order           ServiceOrder?  @relation(fields: [orderId], references: [id])
  
  items           InvoiceItem[]
  payments        Payment[]
  
  createdBy       String
  createdAt       DateTime       @default(now())
  paidAt          DateTime?
  
  @@map("invoices")
  @@index([storeId])
}

model InvoiceItem {
  id          String   @id @default(uuid())
  type        String   // 'service' | 'part' | 'accessory'
  description String
  quantity    Int
  unitPrice   Decimal  @db.Decimal(12, 2)
  total       Decimal  @db.Decimal(12, 2)
  
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@map("invoice_items")
}

model Payment {
  id          String        @id @default(uuid())
  method      PaymentMethod
  amount      Decimal       @db.Decimal(12, 2)
  amountVES   Decimal?      @db.Decimal(12, 2)
  reference   String?
  bankName    String?
  phoneNumber String?
  email       String?
  timestamp   DateTime      @default(now())
  
  invoiceId   String
  invoice     Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@map("payments")
}

// ==================== CAJA Y PETTY CASH ====================

model CashRegister {
  id              String          @id @default(uuid())
  
  // Apertura
  openingUSD      Decimal         @db.Decimal(12, 2)
  openingVES      Decimal         @db.Decimal(12, 2)
  
  // Cierre (blind close)
  declaredUSD     Decimal?        @db.Decimal(12, 2)
  declaredVES     Decimal?        @db.Decimal(12, 2)
  
  // Sistema
  systemUSD       Decimal         @db.Decimal(12, 2)
  systemVES       Decimal         @db.Decimal(12, 2)
  
  // Discrepancia
  discrepancyUSD  Decimal?        @db.Decimal(12, 2)
  discrepancyVES  Decimal?        @db.Decimal(12, 2)
  
  status          RegisterStatus
  
  // Relaciones
  storeId         String
  store           Store           @relation(fields: [storeId], references: [id])
  openedById      String
  openedBy        User            @relation(fields: [openedById], references: [id])
  closedById      String?
  
  expenses        PettyCashExpense[]
  
  openedAt        DateTime        @default(now())
  closedAt        DateTime?
  
  @@map("cash_registers")
  @@index([storeId])
}

model PettyCashExpense {
  id              String       @id @default(uuid())
  description     String
  amount          Decimal      @db.Decimal(12, 2)
  currency        String       // 'USD' | 'VES'
  category        String
  
  // Evidencia fotográfica obligatoria (V4.0)
  receiptPhotos   String[]     // URLs de fotos
  
  registerId      String
  register        CashRegister @relation(fields: [registerId], references: [id], onDelete: Cascade)
  createdBy       String
  createdAt       DateTime     @default(now())
  
  @@map("petty_cash_expenses")
}

// ==================== AUDITORÍA (V4.0) ====================

model AuditLog {
  id          String    @id @default(uuid())
  action      String    // 'CREATE' | 'UPDATE' | 'DELETE' | 'LOGIN' | etc.
  entityType  String    // 'order' | 'invoice' | 'rate' | etc.
  entityId    String
  
  // Cambios
  oldValue    Json?
  newValue    Json?
  
  // Metadata
  ipAddress   String
  userAgent   String?
  
  // Multi-tenancy
  storeId     String?
  
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  
  timestamp   DateTime  @default(now())
  
  @@map("audit_logs")
  @@index([entityType, entityId])
  @@index([userId])
  @@index([timestamp])
  @@index([storeId])
}

// ==================== CONFIGURACIÓN ====================

model WhatsAppTemplate {
  id          String   @id @default(uuid())
  name        String
  trigger     String
  content     String
  variables   String[]
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("whatsapp_templates")
}

model AppSetting {
  id                          String   @id @default(uuid())
  companyName                 String   @default("SERVISTECH")
  logo                        String?
  termsAndConditions          String   @default("")
  
  // Garantía
  defaultWarrantyDays         Int      @default(90)
  warrantyFundPercentage      Decimal  @default(10) @db.Decimal(5, 2)
  
  // Financiero
  igtfPercentage              Decimal  @default(3) @db.Decimal(5, 2)
  
  // Tasas
  bcvAutoSync                 Boolean  @default(true)
  bcvSyncHour                 Int      @default(8)
  useBinanceRate              Boolean  @default(false)
  
  // WhatsApp
  whatsappEnabled             Boolean  @default(true)
  
  // Comisiones default
  defaultTechnicianRate       Decimal  @default(35) @db.Decimal(5, 2)
  defaultEncargadaFlatRate    Decimal  @default(1) @db.Decimal(10, 2)
  defaultEncargadaAccessoryRate Decimal @default(10) @db.Decimal(5, 2)
  
  updatedAt                   DateTime @updatedAt
  
  @@map("app_settings")
}

// ==================== PRINT FORMATS ====================

model PrintFormat {
  id          String   @id @default(uuid())
  name        String
  type        String   // 'receipt' | 'order' | 'invoice' | 'label'
  header      String
  footer      String
  showLogo    Boolean  @default(true)
  showQR      Boolean  @default(true)
  isDefault   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("print_formats")
}
